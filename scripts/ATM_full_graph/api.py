from algo import Algo
from scripts.Utils.PSQLutils.config import (ServerConf,
                                            TableRoutes,
                                            TableRoutesToMAI,
                                            TableATMAllowedNew)
from time import time
from fastapi import FastAPI, Form
from typing import Annotated
import uvicorn
app = FastAPI()

algos = Algo(
    db_server_conf=ServerConf,
    db_table_atm_nn=TableATMAllowedNew,
    db_table_routes=TableRoutes,
    db_table_routes_MAI=TableRoutesToMAI
)
start = time()
algos._init_routes()
print('инициализация маршрутов из БД: ',time() - start)
start = time()
algos._init_graph()
print('инициализация графа: ',time() - start)
start = time()
algos._init_TSP_driver()
print('инициализация тсп: ', time() - start)

[3405256534, 5072905558, 7263998989, 12188595915, 9221097231, 1883783145, 9221097054, 9221096938, 6398039983, 4686934585, 1286587293, 8916027506, 11171038095, 4897208706, 3298948765, 2788217118, 9959933817, 2378295784, 9221097480, 924267480, 9221097485, 1817510197, 5068427922, 4703535202, 9221097490, 1818266062, 4716997993, 938070071, 5351716219, 4852619947, 9221097221, 8006896657, 6777082536, 4897208707, 6501181790, 9097160500, 9221097083, 6777023360, 2596320761, 6769102883, 1286587049, 3613464464, 4874716017, 9221096979, 7670717742, 9221097499, 3076430202, 4739936440, 4504211974, 9718286418, 1272830760, 7669855530, 6501181789, 6501181788, 5667330835, 1329350034, 4083152789, 10841373799, 4711754089, 6124719986, 701246437, 4580648693, 6777080772, 9221096958, 961866438, 2590816084, 5764435044, 1332146851, 5771727438, 9221096932, 8237624718, 9221097201, 4199061890, 9221096928, 9221096927, 6777061172, 4421649691, 4073297424, 9221097481, 5087499921, 9446929633, 938070115, 2940982952, 5545622121, 7341815471, 4078444714, 5546399021, 4991372320, 8486840003, 4813938136, 3437734151, 9221096982, 9221097491, 938253610, 4023618520, 4070321309, 4324874281, 8356963965, 4983944978, 2352525828, 9221097198, 2625463244, 3908290071, 11173518589, 4703535203, 3526824258, 5199976045, 4362163929, 4909411066, 9341937034, 3541486188, 1896753233, 2940986237, 1086716549, 9221096977, 9985138767, 9221097196, 8154434483, 8676050665, 9097160501, 8676050666, 9221096983, 3478996674, 3329224116, 5351709656, 6402526624, 2626629800, 6777031396, 6777082539, 11173518588, 934548772, 3842373556, 4382023466, 9221096922, 3631729777, 9221097486, 9718286429, 4520378790, 8370874232, 4053202882, 9221096954, 2627628632, 4069944094, 1286587306, 3218390301, 2560452107, 4648878581, 11343828318, 2611535851, 12026306247, 6124942585, 9248426817, 10209861432, 9221097446, 7746379165, 4348267691, 9261399594, 2627662764, 3893618245, 9769555911, 4504211975, 2748288141, 7670717739, 8676050667, 939214602, 8237711133, 2611760899, 8006896667, 2611760893, 1324794223, 4916258317, 4921153437, 2499279512, 1424886799, 3007434083, 7682548802, 7159408620, 8529742062, 6777031285, 1324794217, 2625463222, 9937432818, 4349721892, 3398360838, 9996849890, 3512452649, 4450367661, 11481235075, 10288133351, 4349721893, 1955393561, 8006896665, 9718286879, 3007434081, 4512760793, 9221097497, 4977568541, 9221097350, 9221097090, 8006902329, 4508937689, 2110382414, 4909411067, 6680114938, 12052800011, 6777023370, 6777031372, 627937161, 2611726628, 938253576, 6777080759, 10309568720, 10288133349, 2268611061, 2627671487, 2113515418, 11295399327, 3153898584, 939217288, 1329350052, 9118543561, 4728928790, 9221096985, 4124346492, 4904836626, 1655792062, 5643792691, 2626942700, 5597337971, 11171038096, 4070021191, 2627628664, 2870319823, 1286587358, 4384769700, 9221089949, 2167788752, 9718286684, 3252650533, 938070111, 1988390151, 4336633490, 7589687134, 9221096919, 7682548803, 11289345386, 1286587382, 5551583498, 9297620547, 4528816201, 4126073933, 8529742063, 9221097479, 6634172578, 6769113501, 6231778025, 3326157053, 1286587390, 5273639600, 6777070316, 8237711134, 4226622397, 4693441291, 1625449565, 656132952, 2611672577, 5337288912, 4343523536, 4117098594, 5339901687, 9221096945, 4127700589, 6769113594, 5351716220, 3094540596, 884420360, 5400998399, 4191912157, 6777023304, 2626849744, 6777031356, 4318697442, 4558966089, 8405792368, 9221097498, 8006896666, 4576758488, 9646160424, 8963762293, 8772465452, 8909993993, 9718286917, 3650549481, 2611760890, 5770747056, 4487458826, 7036905766, 5518594822, 1754270616, 2625463220, 12059173935, 11487140663, 11481235076, 5894578757, 11717137969, 7670727095, 3683499632, 9254359675, 4298747698, 4327588190, 6633733371, 4964043423, 2007250839, 3783312674, 1286587031, 12247899614, 9221096942, 2851581007, 7655922576, 1929099935, 5407468148, 4130650329, 4384769701, 5446041188, 9221096929, 1628954787, 9221097023, 3583952360, 514169772, 4127700689, 1579582737, 1286587391, 9254359674, 6488180932, 6206469994, 4245257589, 6777041953, 4318697447, 11619507158, 7670717710, 938253590, 5218798144, 1286587257, 2284308668, 9221096971, 1082239969, 5478755199, 3657565818, 10811625618, 8026209385, 4310019889, 5016401921, 8198518793, 1286586921, 1817510200, 4070035289, 4991374251, 4285874992, 11288672948, 3725026903, 5599714449, 5108910290, 4693450591, 4683881474, 4994501821, 5244167439, 2625463223, 2627597737, 4151982905, 5265370419, 7121996385, 2625460126, 6777084616, 2452280762, 7001514236, 7047296617, 7121995585, 2335274369, 2059700851, 9718286918, 2594504921, 9718286831, 1688117100, 1667728175, 9718286519, 9062105931, 9297620552, 9221096930, 9221096934, 1286586888, 1286586784, 8282135345, 691744699, 9221097212, 588069762, 10238025893, 938070079, 5240047814, 5223109022, 4337419790, 9996849889, 2876845174, 1827648502, 1817510198, 1758067323, 1693654699, 6207683286, 9718286785, 3740110019, 3735078080, 1579582736, 9718286607, 4860079584, 9718286523, 3685929576, 9507030086, 12159545258, 4687261465, 1286587267, 9221097021, 1229461501, 3749360999, 5382891423, 1963480933, 2583161219, 2626942697, 5810791379, 4298816691, 2627628649, 6777080754, 10841373800, 10572314648, 10922438337, 1329350040, 6140344622, 4348262591, 4423683390, 6769113486, 1758067322, 3756053512, 6423573035, 4930362421, 4926705542, 2627597733, 3749361000, 618112479, 1669762914, 9718286540, 10922438338, 1625449558, 8867964994, 1728779782, 9750312015, 6777082542, 2627806009, 9221097349, 4685691365, 4310187839, 9221096966, 2140237416, 7350916060, 5275706953, 4127528689, 9221096986, 3404487741, 4559790741, 9221096926, 6140344623, 1986978833, 10669825284, 2092870514, 1550428913, 10922438339, 1286587231, 12247899617, 9221096960, 1172054320, 4412901196, 4285863691, 1172065741, 3410453576, 1399520150, 1286587379, 1389186868, 2611760900, 1351565031, 1351526948, 9221096840, 6769113499, 9537436756, 4887361621, 7670717219, 5343376857, 938070122, 5164414192, 5154817852, 6777023300, 6171249281, 4347697153, 4243080396, 1883783144, 5538199616, 7881464883, 8006896669, 941766735, 4250489696, 3733213053, 6400217985, 6777084624, 3053223974, 6361772615, 2455480483, 1842900806, 4315683889, 5481463449, 9246049840, 938070061, 4259313892, 937713832, 4321067437, 12048027167, 1172063290, 4103678289, 11327691761, 4325187293, 4327593691, 4343899491, 11526519008, 12092080396, 9718286690, 4413683361, 3749361001, 4384764023, 9287137636, 4318697440, 4551158390, 5108309425, 1531266598, 6808207585, 6943361882, 2627628636, 7126057126, 2186629303, 3071821064, 5286213655, 2016386743, 2898527938, 5088305792, 8006896664, 2626942699, 6503797885, 2500443061, 6769113508, 1286587107, 2612128384, 1320050774, 6770262166, 3341683386, 6777023383, 6777023376, 5801480654, 12219274617, 12159545261, 11224311988, 12159545260, 10085664451, 5208111822, 7832507815, 5502237111, 4318697444, 2181347854, 5770731156, 6769113595, 2626849747, 4037292824, 2626653669, 11699186376, 6777041957, 938253562, 7929466097, 9718286452, 9718275888, 9221097211, 9221096910, 4789434221, 8956969827, 1329350038, 8758277952, 3249138872, 4909411063, 9718286738, 1903646830, 4527751490, 1286587352, 9221097495, 4438972103, 9718286648, 9221096941, 6646365237, 9379350935, 6357343214, 6503797886, 4697743561, 6306728637, 6429641934, 5702925535, 4420922468, 8507803831, 4318697443, 9718286494, 8757802471, 4315677892, 7082257368, 4870352361, 9033006900, 4408185294, 4717871885, 8758277943, 4716997992, 408385048, 1951643940, 4027401020, 4035589936, 1885193738, 2627628693, 678295632, 2280266048, 1611748611, 1529308055, 2134694753, 1095382764, 1751373247, 2447156903, 2611760888, 1000785708, 4027401021, 4294686299, 2432112617, 6984468091, 7082257367, 8758277937, 8758277940, 7640415432, 5435796627, 1744047883, 11288672950, 5525203626, 2627597739, 5540586822, 4027401022, 4551174889, 4207577782, 6633733370, 3071819224, 4909261742, 4730757809, 618112491, 6634144353, 6777080750, 4527751489, 12247899616, 4690945932, 6777080774, 4960497813, 2979638464, 6777031371, 2612128380, 9233445190, 9251425041, 4560019783, 1286587356, 1870260491, 8412899969, 4574490292, 1619081354, 941731758, 3194244152, 10697371893, 4931308421, 918690001, 5218798143, 5170950022, 9221096785, 2953468322, 1204691868, 9221096825, 996053915, 634805752, 2626653667, 6777084691, 6398564171, 2321688535, 6574700111, 7545652060, 2119440249, 7640415431, 6635636774, 6635636775, 6777059082, 6777031408, 6777070194, 700872444, 7826963969, 2611760898, 12247899613, 5719859527, 6777031378, 11181695310, 6680114934, 11841159841, 2555299245, 4537516554, 6944280773, 1286587368, 5022331923, 6956796850, 4144794768, 4693451389, 6777070309, 9494695518, 2615442256, 4199200424, 4703535204, 1233308052, 4904558526, 5034498542, 6634144351, 9610759341, 4889619935, 1272543254, 4519265389, 4114907679, 4262574823, 2627597734, 3768556411, 4364555975, 8252412485, 8477026987, 5382891227, 4318697446, 8810943067, 3700986285, 2181319243, 1653071981, 11617079709, 5226130695, 6153225178, 6967025610, 2626849743, 1611748605, 5186059820, 9326552063, 12249069355, 7682430811, 4682436791, 2016386878, 5089140022, 8006902331, 6216728896, 5130480322, 1722830585, 5426372721, 7682430808, 2108747232, 5387438122, 1507817306, 5601187521, 1286587351, 9221097477, 4933319851, 4960088739, 5267440622, 1201461579, 5694380126, 2611760901, 630992218, 751993285, 912959835, 11822889767, 10119667789, 938070104, 3646541597, 9718286951, 4558862297, 3834400133, 4144794763, 11617079712, 8080451857, 9365408179, 3703739044, 5538199618, 5533146721, 4366482901, 9396692410, 8486840004, 8629907689, 2627597736, 5341569687, 5226857790, 5582720126, 10267864011, 9718286915, 3507397025, 2656349128, 9221096763, 9221096837, 1296939896, 1229461506, 9996849885, 1286587186, 938253604, 5296129137, 4736660060, 8026218185, 4728957727, 6769113596, 6777031352, 6777031373, 6777061125, 6777061155, 2611708769, 6777070327, 6777082624, 717340926, 7086856379, 2626629798, 11197689058, 2017583578, 5719859526, 9510617338, 2017583575, 7762570402, 7931930179, 4318697441, 9996849884, 2611760895, 6777019579, 6777031375, 5027243524, 9828857417, 6777061147, 1274623215, 9221097343, 6776897993, 7931930178, 8507803830, 3672326247, 11477279180, 1734117142, 11617079711, 5341356351, 6207683287, 4250621605, 6777070207, 2627783590, 9046328284, 6262657451, 4080209289, 3980376856, 1494166617, 2656349124, 5248724851, 3072553204, 5343774508, 4573749743, 3541832209, 4871521422, 4771892327, 941731749, 11623725790, 8154434484, 6046142494, 4207884489, 8252410980, 1286587254, 3768556410, 5478694486, 7182382749, 2611760902, 1082826589, 8672487736, 938070089, 5478694487, 12161768699, 9221096729, 8091202799, 5694380127, 12000692198, 4872597421, 9046328283, 751993249, 11164804857, 3396803236, 11477263262, 3447562631, 5394375149, 6777070212, 11409835104, 6777070315, 6340159804, 614958544, 9221096730, 1201461584, 5071321855, 5382888465, 5130449524, 614980357, 6364967723, 11617079713, 6777084613, 6793335323, 7126057125, 9221097487, 2112691667, 1952629418, 6777023385, 3806834364, 9221097194, 1235549083, 3043881936, 1681997274, 6679888641, 9221096990, 444776911, 4861374222, 3720509245, 2627628630, 6071309998, 2627628670, 6438279129, 2611726627, 1986978832, 2626849745, 679133230, 4844411022, 7048869821, 791443260, 2627783585, 4466264595, 6047084287, 11718405531, 2627741509, 1286587353, 9221096940, 2808972049, 9221096923, 3558465029, 6777023387, 4693451289, 1202220890, 6645887671, 4120902789, 4102826189, 1286587222, 2612128375, 6681156485, 1396687183, 9113816156, 3006586609, 12000692199, 1374552908, 8080478744, 1203193430, 751993252, 7074821819, 6634144352, 4998573630, 9480875899, 4303395892, 1296939902, 9221097238, 11033189877, 941731733, 12219008731, 9318132160, 4960088743, 4809411208, 4558524492, 9718286809, 2564046956, 5250605458, 3683874533, 9718286470, 4701733243, 2626849750, 2626907992, 2100459507, 4604812938, 9718286647, 4852619945, 3212676152, 8818694934, 938253588, 1976909718, 3716041760, 9263040699, 2611760905, 982315284, 1185150642, 4951556069]


@app.post('/algos/david_roller_gpt___david_roller_gpt')
def return_tsp_sol(atms: Annotated[list, Form()]):
    algos.init_david_roller_gpt__david_roller_gpt()
    atms = list(map(int, atms[0].split(',')))
    return algos.calculate_ensemble_of_routes(atms)

@app.post('/algos/david___david')
def return_tsp_sol(atms: Annotated[list, Form()]):
    algos.david___david()
    atms = list(map(int, atms[0].split(',')))
    return algos.calculate_ensemble_of_routes(atms)

@app.post('/algos/empty___david')
def return_tsp_sol(atms: Annotated[list, Form()]):
    algos.empty___david()
    atms = list(map(int, atms[0].split(',')))
    return algos.calculate_ensemble_of_routes(atms)


if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)